<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.scifi.pubreader.infrastructure.mapper.BookMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="cn.scifi.pubreader.infrastructure.po.BookPO">
        <result column="id" property="id" />
        <result column="title" property="title" />
        <result column="author" property="author" />
        <result column="summary" property="summary" />
        <result column="cover_url" property="coverUrl" />
        <result column="channel" property="channel" />
        <result column="category_id" property="categoryId" />
        <result column="category_name" property="categoryName" />
        <result column="sub_category_id" property="subCategoryId" />
        <result column="sub_category_name" property="subCategoryName" />
        <result column="word_count" property="wordCount" />
        <result column="read_count" property="readCount" />
        <result column="last_chapter_id" property="lastChapterId" />
        <result column="last_chapter_title" property="lastChapterTitle" />
        <result column="last_chapter_update_time" property="lastChapterUpdateTime" />
        <result column="status" property="status" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, title, author, summary, cover_url, channel, category_id, category_name, sub_category_id, sub_category_name, word_count, read_count, last_chapter_id, last_chapter_title, last_chapter_update_time, status, create_time, update_time
    </sql>

    <select id="selectWithConditions" resultType="cn.scifi.pubreader.infrastructure.po.BookPO">
        SELECT
        b.id, b.title, b.author, b.summary, b.cover_url, b.channel,
        b.category_id, b.category_name, b.sub_category_id, b.sub_category_name,
        b.word_count, b.last_chapter_id, b.last_chapter_title, b.last_chapter_update_time, b.status
        FROM novel_book b
        <if test="cond.tagId != null">
            LEFT JOIN novel_book_tag bt ON b.id=bt.book_id
        </if>
        <where>
            <if test="cond.title != null and cond.title != ''">
                b.title LIKE CONCAT('%', #{cond.title}, '%')
            </if>
            <if test="cond.categoryId != null">
                AND (b.category_id=#{cond.categoryId} OR b.sub_category_id=#{cond.categoryId})
            </if>
            <if test="cond.channel != null">
                AND b.channel=#{cond.channel}
            </if>
            <if test="cond.bookStatus != null">
                AND b.status=#{cond.bookStatus}
            </if>
            <if test="cond.updateDays != null">
                AND DATEDIFF(NOW(), b.last_chapter_update_time) &lt;= #{cond.updateDays}
            </if>
            <if test="cond.countFrom != null">
                AND b.word_count &gt;= #{cond.countFrom}
            </if>
            <if test="cond.countTo != null">
                AND b.word_count &lt; #{cond.countTo}
            </if>
            <if test="cond.tagId != null">
                AND bt.tag_id=#{cond.tagId}
            </if>
        </where>
        <if test="cond.tagId != null">
            GROUP BY b.id
        </if>
    </select>

    <select id="selectByAuthor" resultType="cn.scifi.pubreader.infrastructure.po.BookPO">
        SELECT
            b.id, b.title, b.author, b.summary, b.cover_url, b.channel,
            b.word_count, b.last_chapter_id, b.last_chapter_title, b.status
        FROM novel_book b WHERE b.author=#{author}
    </select>

</mapper>
